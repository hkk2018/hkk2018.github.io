<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Database(Mssql) | hkk技術筆記</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/assets/css/0.styles.35bcedcf.css" as="style"><link rel="preload" href="/assets/js/app.17b4c9e2.js" as="script"><link rel="preload" href="/assets/js/2.655d080d.js" as="script"><link rel="preload" href="/assets/js/17.262e4990.js" as="script"><link rel="prefetch" href="/assets/js/10.f926c07f.js"><link rel="prefetch" href="/assets/js/11.8f6b32bb.js"><link rel="prefetch" href="/assets/js/12.b51113f4.js"><link rel="prefetch" href="/assets/js/13.425378d9.js"><link rel="prefetch" href="/assets/js/14.5998b87c.js"><link rel="prefetch" href="/assets/js/15.3227b31a.js"><link rel="prefetch" href="/assets/js/16.ae896d5b.js"><link rel="prefetch" href="/assets/js/18.ce50ddae.js"><link rel="prefetch" href="/assets/js/19.8cd28f64.js"><link rel="prefetch" href="/assets/js/20.96a9dfdd.js"><link rel="prefetch" href="/assets/js/21.952957a5.js"><link rel="prefetch" href="/assets/js/22.4ca6a2ae.js"><link rel="prefetch" href="/assets/js/23.120e83f6.js"><link rel="prefetch" href="/assets/js/24.1cff89a2.js"><link rel="prefetch" href="/assets/js/25.79c9739f.js"><link rel="prefetch" href="/assets/js/26.7021b5e4.js"><link rel="prefetch" href="/assets/js/27.a7b6813e.js"><link rel="prefetch" href="/assets/js/28.0eaf2b30.js"><link rel="prefetch" href="/assets/js/29.58880400.js"><link rel="prefetch" href="/assets/js/3.f3b78e7f.js"><link rel="prefetch" href="/assets/js/30.9956aeb1.js"><link rel="prefetch" href="/assets/js/31.6e68e94a.js"><link rel="prefetch" href="/assets/js/32.0ba49509.js"><link rel="prefetch" href="/assets/js/33.2a59d970.js"><link rel="prefetch" href="/assets/js/34.4d994f82.js"><link rel="prefetch" href="/assets/js/35.32faa4d7.js"><link rel="prefetch" href="/assets/js/36.1850f327.js"><link rel="prefetch" href="/assets/js/4.a882d978.js"><link rel="prefetch" href="/assets/js/5.16819666.js"><link rel="prefetch" href="/assets/js/6.3fc1f5ca.js"><link rel="prefetch" href="/assets/js/7.02aa2f30.js"><link rel="prefetch" href="/assets/js/8.c081bcbf.js"><link rel="prefetch" href="/assets/js/9.b4145f6a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.35bcedcf.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">hkk技術筆記</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/一般/WebDev.html" class="nav-link">
  一般
</a></div><div class="nav-item"><a href="/MicroSoft/DotNet.html" class="nav-link">
  MicroSoft
</a></div><div class="nav-item"><a href="/JS/Quirks.html" class="nav-link">
  JS
</a></div><div class="nav-item"><a href="/TS/" class="nav-link">
  TS
</a></div><div class="nav-item"><a href="/Unreal/FAQ.html" class="nav-link">
  Unreal
</a></div><div class="nav-item"><a href="/Html&amp;Css/Css.html" class="nav-link">
  Html&amp;Css
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/一般/WebDev.html" class="nav-link">
  一般
</a></div><div class="nav-item"><a href="/MicroSoft/DotNet.html" class="nav-link">
  MicroSoft
</a></div><div class="nav-item"><a href="/JS/Quirks.html" class="nav-link">
  JS
</a></div><div class="nav-item"><a href="/TS/" class="nav-link">
  TS
</a></div><div class="nav-item"><a href="/Unreal/FAQ.html" class="nav-link">
  Unreal
</a></div><div class="nav-item"><a href="/Html&amp;Css/Css.html" class="nav-link">
  Html&amp;Css
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/MicroSoft/DotNet.html" class="sidebar-link">.Net</a></li><li><a href="/MicroSoft/DB.html" aria-current="page" class="active sidebar-link">Database(Mssql)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/MicroSoft/DB.html#installation-configuration" class="sidebar-link">Installation &amp; Configuration</a></li><li class="sidebar-sub-header"><a href="/MicroSoft/DB.html#to-update-db-but-avoid-replacing-data" class="sidebar-link">To update DB but avoid replacing data</a></li><li class="sidebar-sub-header"><a href="/MicroSoft/DB.html#make-values-into-dot-separated-string-by-xml-path" class="sidebar-link">Make values into dot-separated string by Xml Path</a></li><li class="sidebar-sub-header"><a href="/MicroSoft/DB.html#t-sql-formatter-won-t-change-case-of-variables" class="sidebar-link">T-Sql Formatter (won't change case of variables)</a></li><li class="sidebar-sub-header"><a href="/MicroSoft/DB.html#quirks" class="sidebar-link">Quirks</a></li><li class="sidebar-sub-header"><a href="/MicroSoft/DB.html#fastest-way-to-copy-stored-procedure" class="sidebar-link">Fastest Way to Copy Stored Procedure</a></li><li class="sidebar-sub-header"><a href="/MicroSoft/DB.html#fast-input-params-into-sp-template" class="sidebar-link">Fast Input Params Into SP Template</a></li><li class="sidebar-sub-header"><a href="/MicroSoft/DB.html#用戶端統計資料" class="sidebar-link">用戶端統計資料</a></li><li class="sidebar-sub-header"><a href="/MicroSoft/DB.html#paginate" class="sidebar-link">Paginate</a></li></ul></li><li><a href="/MicroSoft/DB-syntax.html" class="sidebar-link">Sql Server語法</a></li><li><a href="/MicroSoft/Win10.html" class="sidebar-link">Windows Usage</a></li><li><a href="/MicroSoft/PowerShell.html" class="sidebar-link">Power Shell</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="database-mssql"><a href="#database-mssql" class="header-anchor">#</a> Database(Mssql)</h1> <h2 id="installation-configuration"><a href="#installation-configuration" class="header-anchor">#</a> Installation &amp; Configuration</h2> <p>When <code>An error has occurred while establishing a connection to the server.</code>
Make sure that</p> <ol><li>service is already started.</li> <li>TCP/IP is enabled in SQL Server Configuration.</li> <li>firewall(default port 1433)</li> <li><code>Allow remote connections to this server</code> in MSSMS is checked.</li></ol> <p>ref : <a href="http://sas.tw/sas/redirect.php?tid=10615&amp;goto=lastpost" target="_blank" rel="noopener noreferrer">解決SQL Server管理器無法連接遠端資料庫的問題<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="to-update-db-but-avoid-replacing-data"><a href="#to-update-db-but-avoid-replacing-data" class="header-anchor">#</a> To update DB but avoid replacing data</h2> <ul><li>Save <a href="https://blog.miniasp.com/post/2008/06/05/Find-out-T-SQL-commands-generated-by-SQL-Server-Management-Studio" target="_blank" rel="noopener noreferrer"><code>Change Script</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> when altering tables.</li> <li>To export stored procedures(or specific tables):
<ol><li>right click on Db =&gt; <code>Tasks</code>(工作)</li> <li><code>Generate Scripts</code>(產生指令碼)</li> <li>Choose what to save, and click next</li> <li>Choose <code>Script DROP and CREATE</code></li></ol></li> <li>Probably save some CRUD scripts manually</li></ul> <h2 id="make-values-into-dot-separated-string-by-xml-path"><a href="#make-values-into-dot-separated-string-by-xml-path" class="header-anchor">#</a> Make values into dot-separated string by Xml Path</h2> <p>Senario：CMS needs to know relationship between new title and its categories(1 to n), but web doesn't for the sake of reducing internete usage.<br>
（Also for the compatibility against older version sql server, otherwise String_split）</p> <p>Example:</p> <div class="language- extra-class"><pre><code>SELECT
    A,B,...,
    iif ( @isWebDisplay = 1, '',
        SUBSTRING(
            (
                SELECT (',' + CAST(cateId AS varchar(100)))
                FROM [AgSportDb].[dbo].NewTitleToCate
                WHERE NewTitleToCate.newsTitleId = titleId
                FOR xml PATH ('')
            ), 2, 100
        )
    ) as cateIds
</code></pre></div><p>it's fine to set 3rd param of SUBSTRING with an aribitrary value as long as it's big enough.<br>
Great ref：<a href="https://www.cnblogs.com/doubleliang/archive/2011/07/06/2098775.html" target="_blank" rel="noopener noreferrer">灵活运用 SQL SERVER FOR XML PATH<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="t-sql-formatter-won-t-change-case-of-variables"><a href="#t-sql-formatter-won-t-change-case-of-variables" class="header-anchor">#</a> T-Sql Formatter (won't change case of variables)</h2> <p><a href="https://sql-format.com/" target="_blank" rel="noopener noreferrer">Sql Formatter<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="quirks"><a href="#quirks" class="header-anchor">#</a> Quirks</h2> <ol><li>有output parameter的話， c#端一定要接到。</li> <li>某欄位a若為null，不但a=null抓不到，連a=a都抓不到。</li></ol> <h2 id="fastest-way-to-copy-stored-procedure"><a href="#fastest-way-to-copy-stored-procedure" class="header-anchor">#</a> Fastest Way to Copy Stored Procedure</h2> <p>修改，然後將ALTER改成CREATE</p> <h2 id="fast-input-params-into-sp-template"><a href="#fast-input-params-into-sp-template" class="header-anchor">#</a> Fast Input Params Into SP Template</h2> <p>在新增的SP頁面中按Ctrl+Shift+M</p> <h2 id="用戶端統計資料"><a href="#用戶端統計資料" class="header-anchor">#</a> 用戶端統計資料</h2> <h3 id="時間單位"><a href="#時間單位" class="header-anchor">#</a> 時間單位</h3> <p>毫秒，可測試以</p> <div class="language- extra-class"><pre><code>WAITFOR DELAY '00:00:01'
</code></pre></div><p><a href="https://social.msdn.microsoft.com/Forums/sqlserver/en-US/edafe533-4d56-4d82-b654-9601d356675b/unit-of-timestatistics-in-client-statistics?forum=sqlgetstarted" target="_blank" rel="noopener noreferrer">ref<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>:</p> <h2 id="paginate"><a href="#paginate" class="header-anchor">#</a> Paginate</h2> <h3 id="paginate-body"><a href="#paginate-body" class="header-anchor">#</a> Paginate Body</h3> <div class="language- extra-class"><pre><code>USE [YourDB]
GO

/****** Object:  StoredProcedure [dbo].[Paginate]    Script Date: 2020/3/11 下午 03:13:04 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


-- =============================================
-- Author:hkk
-- Create date: 
-- Description:
-- =============================================
CREATE PROCEDURE [dbo].[Paginate] 
    -- Add the parameters for the stored procedure here
    @pageSize int= 10,
    @whichPage int=-1,
    @totalPage int output,
    @whatToOrderBy nvarchar(50)='rowNum'
AS
BEGIN
-- SET NOCOUNT ON added to prevent extra result sets from
-- interfering with SELECT statements.
SET NOCOUNT ON;

-- Insert statements for procedure here

--Ceiling內轉為浮點數後，似乎不是輸出整數以至於C#(int)轉換跳錯
SELECT
    @totalPage = CAST(CEILING(CAST(COUNT(*) AS float) / @pageSize) AS int)
FROM #temp;


DECLARE @stmt nvarchar(400),
        @startIndex int,
        @paramsDefinition nvarchar(300);


-- 複製輸出格式(但不用宣告變數) UNION是為了洗掉自動識別項，讓其成為彷彿一個無自動識別的表格（之所以複製）
SELECT TOP (0) * INTO #takeBackDataTable FROM #temp
UNION ALL
SELECT TOP (0) * FROM #temp;
--SET IDENTITY_Insert #takeBackDataTable ON; --試老半天沒用

SET @startIndex = (@whichPage - 1) * @pageSize;

--經過實際測驗 同樣收到已經標示RowNum的資料，FETCH結論是無論WHERE或FETCH以PK作尋條件快1倍，但FETCH快WHERE 30%
--@whatToOrderBy的位置由於不能透過變數的方式填入（系統報錯），所以改成純用字串串接，但無Injection風險，因為其乃預存程序中指定，不會從外部填入
SET @stmt = '
INSERT INTO #takeBackDataTable SELECT * FROM  #temp ORDER BY ' + @whatToOrderBy +
' OFFSET @startIndex ROWS FETCH NEXT @pageSize ROWS ONLY;';

SET @paramsDefinition = '@pageSize int,@startIndex int';
EXEC dbo.sp_executesql @stmt,
                        @paramsDefinition,
                        @pageSize,
                        @startIndex;

SELECT * FROM #takeBackDataTable
END
GO
</code></pre></div><p>但由傳入#temp方法不同，效能上有差異。</p> <div class="language- extra-class"><pre><code>USE [YourDB]
GO

/****** Object:  StoredProcedure [dbo].[Users_Basics#Get]    Script Date: 2020/3/11 下午 03:16:27 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:hkk
-- Create date: 
-- Description:
-- =============================================
CREATE PROCEDURE [dbo].[Users_Basics#Get] 
    -- Add the parameters for the stored procedure here
    @pageSize int = 10, 
    @whichPage int = 1,
    @totalPage int output

AS
BEGIN
    -- SET NOCOUNT ON added to prevent extra result sets from
    -- interfering with SELECT statements.
    SET NOCOUNT ON;
    
    -- Insert statements for procedure here
    --法1(先宣告再定PK) 需17.7毫秒
    /*
    SELECT
    *,
    ROW_NUMBER() OVER (ORDER BY createT DESC) AS rowNum INTO #temp
    FROM Users_Basics
    WHERE deleteFlag = 0;
    ALTER TABLE #temp ALTER COLUMN rowNum int NOT NULL;
    ALTER TABLE #temp ADD PRIMARY KEY NONCLUSTERED (rowNum);
    */

    --法2 需11.8毫秒(先宣告空Table，再定PK，再插入資料)
    /*
    SELECT TOP (0)
    *,
    0 AS rowNum INTO #temp
    FROM Users_Basics
    UNION ALL
    SELECT TOP (0)
    *,
    0 AS rowNum
    FROM Users_Basics;
    ALTER TABLE #temp ALTER COLUMN rowNum int NOT NULL;
    ALTER TABLE #temp ADD PRIMARY KEY NONCLUSTERED (rowNum);
    INSERT INTO #temp
    SELECT
        *,
        ROW_NUMBER() OVER (ORDER BY createT DESC) AS rowNum
    FROM Users_Basics
    WHERE deleteFlag = 0;
    */

    --法3 需7.8毫秒(正式宣告Table，再插入資料)
    
    CREATE TABLE #temp (

    [id] [int] NOT NULL,
    [accountName] [nvarchar](100) NOT NULL,
    [ps] [nchar](34) NOT NULL,
    [alias] [nvarchar](20) NULL,
    [createT] [datetime] NOT NULL,
    [gender] [bit] NULL,
    [deleteFlag] [bit] NULL,
    rowNum int NOT NULL
    PRIMARY KEY (rowNum)
    );

    INSERT INTO #temp
    SELECT
        *,
        ROW_NUMBER() OVER (ORDER BY createT DESC) AS rowNum
    FROM Users_Basics
    WHERE deleteFlag = 0;


    EXEC [dbo].[Paginate] @pageSize,
                        @whichPage,
                        @totalPage,
                        'rowNum';

END
GO
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/MicroSoft/DotNet.html" class="prev">
        .Net
      </a></span> <span class="next"><a href="/MicroSoft/DB-syntax.html">
        Sql Server語法
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.17b4c9e2.js" defer></script><script src="/assets/js/2.655d080d.js" defer></script><script src="/assets/js/17.262e4990.js" defer></script>
  </body>
</html>
